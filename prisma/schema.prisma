// Prisma Schema - Sistema de Gestión Institucional
// Configurado para PostgreSQL en Neon (serverless)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// === AUTENTICACIÓN Y ROLES ===

model User {
  id            String          @id @default(cuid())
  nombre        String
  apellido      String
  email         String          @unique
  passwordHash  String
  activo        Boolean         @default(true)
  creadoEn      DateTime        @default(now())
  legajoId      String?         @unique
  legajo        Legajo?         @relation(fields: [legajoId], references: [id])
  roles         UserRole[]
  permisos      UserPermission[]
  notificaciones Notificacion[]
  auditoriaLogs AuditoriaLog[]

  @@map("users")
}

model Role {
  id     String     @id @default(cuid())
  nombre RoleNombre @unique
  users  UserRole[]

  @@map("roles")
}

enum RoleNombre {
  ADMIN
  SECRETARIA
  TESORERO
  RRHH
  EMPLEADO
}

model UserRole {
  userId String
  roleId String
  user  User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role  Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
  @@map("user_roles")
}

model Permission {
  id     String   @id @default(cuid())
  modulo String
  accion Accion
  users  UserPermission[]

  @@unique([modulo, accion])
  @@map("permissions")
}

enum Accion {
  VER
  CREAR
  EDITAR
  ELIMINAR
}

model UserPermission {
  userId       String
  permissionId String
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([userId, permissionId])
  @@map("user_permissions")
}

// === RECURSOS HUMANOS - LEGAJOS ===

model Legajo {
  id                     String                  @id @default(cuid())
  users                  User[]
  numeroLegajo           Int                     @unique
  nombres                String
  apellidos              String
  dni                    String                  @unique
  cuil                   String?
  fotoUrl                String?
  calle                  String
  numero                 Int
  casa                   String?
  departamento           String?
  piso                   String?
  localidad              String
  codigoPostal           String
  fechaAlta              DateTime
  fechaBaja              DateTime?
  motivoBaja             String?
  celular                String?
  deletedAt              DateTime?
  contactos              ContactoAdicional[]
  configuracionVacaciones ConfiguracionVacaciones?
  solicitudesVacaciones   SolicitudVacaciones[]
  licencias              Licencia[]
  certificados           Certificado[]

  @@index([dni])
  @@index([numeroLegajo])
  @@index([deletedAt])
  @@map("legajos")
}

model ContactoAdicional {
  id          String           @id @default(cuid())
  legajoId    String
  legajo      Legajo           @relation(fields: [legajoId], references: [id], onDelete: Cascade)
  nombres     String
  apellidos   String
  parentesco  Parentesco
  calle       String?
  numero      String?
  casa        String?
  departamento String?
  piso        String?
  telefonos   TelefonoContacto[]

  @@map("contactos_adicionales")
}

enum Parentesco {
  CONYUGE
  HIJO
  PADRE
  MADRE
  HERMANO
  OTRO
}

model TelefonoContacto {
  id        String            @id @default(cuid())
  contactoId String
  contacto  ContactoAdicional @relation(fields: [contactoId], references: [id], onDelete: Cascade)
  numero    String

  @@map("telefonos_contacto")
}

// === MÓDULO DE VACACIONES ===

enum EstadoVacaciones {
  PENDIENTE
  APROBADA
  BAJA
}

model ConfiguracionVacaciones {
  id                Int      @id @default(autoincrement())
  legajoId          String   @unique
  legajo            Legajo   @relation(fields: [legajoId], references: [id], onDelete: Cascade)
  diasDisponibles   Int
  secretarioGeneral String
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model SolicitudVacaciones {
  id              Int               @id @default(autoincrement())
  legajoId        String
  legajo          Legajo            @relation(fields: [legajoId], references: [id], onDelete: Cascade)
  fechaDesde      DateTime
  fechaHasta      DateTime
  diasSolicitados Int
  diasRestantes   Int
  estado          EstadoVacaciones  @default(PENDIENTE)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([legajoId, fechaDesde])
}

// === LICENCIAS (RRHH) ===

enum TipoLicencia {
  ART
  ENFERMEDAD
  ESTUDIO
  MATERNIDAD
  PATERNIDAD
}

enum EstadoLicencia {
  ACTIVA
  FINALIZADA
}

enum TipoArchivo {
  PDF
  JPG
}

enum EtapaCertificado {
  INICIO
  CIERRE
}

model Licencia {
  id            Int               @id @default(autoincrement())
  legajoId      String
  tipoLicencia  TipoLicencia
  fechaInicio   DateTime
  fechaFin      DateTime?
  estado        EstadoLicencia     @default(ACTIVA)
  observaciones String?
  diasMarcados  Json               // array de fechas marcadas en el calendario (ISO strings)
  fechaCierre   DateTime?          // fecha efectiva de finalización al cerrar
  observacionesCierre String?
  creadoEn      DateTime           @default(now())
  actualizadoEn DateTime           @updatedAt
  legajo        Legajo             @relation(fields: [legajoId], references: [id], onDelete: Cascade)
  certificados  Certificado[]
  observacionesNomina ObservacionLicencia[]

  @@index([legajoId])
  @@index([estado])
  @@map("licencias")
}

model ObservacionLicencia {
  id           Int      @id @default(autoincrement())
  licenciaId   Int
  texto        String
  creadoEn     DateTime @default(now())
  actualizadoEn DateTime @updatedAt
  licencia     Licencia @relation(fields: [licenciaId], references: [id], onDelete: Cascade)

  @@index([licenciaId])
  @@map("observaciones_licencia")
}

model Certificado {
  id           Int                @id @default(autoincrement())
  licenciaId   Int
  legajoId     String
  nombreArchivo String
  tipoArchivo  TipoArchivo
  urlArchivo   String
  fechaCarga   DateTime           @default(now())
  etapa        EtapaCertificado
  licencia     Licencia           @relation(fields: [licenciaId], references: [id], onDelete: Cascade)
  legajo       Legajo             @relation(fields: [legajoId], references: [id], onDelete: Cascade)

  @@index([licenciaId])
  @@index([legajoId])
  @@map("certificados")
}

// === NOTIFICACIONES INTERNAS ===

enum TipoNotificacion {
  VACACIONES_APROBADA
  VACACIONES_BAJA
  VACACIONES_BAJA_APROBADA
}

model Notificacion {
  id          Int               @id @default(autoincrement())
  usuarioId   String
  usuario     User              @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  tipo        TipoNotificacion
  titulo      String
  mensaje     String
  leida       Boolean           @default(false)
  solicitudId Int?
  createdAt   DateTime         @default(now())

  @@index([usuarioId, leida])
}

// === AUDITORÍA ===

model AuditoriaLog {
  id         Int      @id @default(autoincrement())
  userId     String
  userNombre String
  userEmail  String
  accion     String
  modulo     String
  detalle    String?
  ip         String?
  creadoEn   DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([modulo])
  @@index([creadoEn])
  @@map("auditoria_logs")
}
